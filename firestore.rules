
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is an administrator
    function isAdmin() {
      return request.auth.uid in ['dqrHnJtM27bMpNudHxO5hL3wsNE3'];
    }

    // Rules for public content that anyone can read, but only admins can write.
    match /{collection}/{docId}
      where collection in ['courses', 'instructors', 'blogPosts', 'events'] {
        allow get, list: if true;
        allow write: if isAdmin();
    }
    
    // Rule for event attendees subcollection
    match /events/{eventId}/attendees/{userId} {
      allow get: if true;
      allow list: if isAdmin(); // Only admins can see the full list of attendees
      allow create: if request.auth.uid == userId; // Users can register themselves
      allow write, delete: if isAdmin(); // Admins can manage attendees
    }

    // Rules for user-specific data
    match /studentProgress/{userId} {
      // Users can read/write their own progress. Admins can read anyone's progress for the dashboard.
      allow read: if request.auth.uid == userId || isAdmin();
      allow create, update: if request.auth.uid == userId;
      // Disallow listing all student progress documents for non-admins to protect privacy
      allow list: if isAdmin();
      // Only admins can delete student profiles.
      allow delete: if isAdmin();
    }
    
    match /feedback/{feedbackId} {
        // Anyone can create feedback (even non-logged-in users)
        allow create: if true;
        // Only admins can read, update, or delete feedback submissions
        allow read, write, delete: if isAdmin();
    }
  }
}
