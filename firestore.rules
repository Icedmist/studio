rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user's UID is in the admin list.
    function isAdmin() {
      // This list must be kept in sync with src/lib/admin.ts
      return request.auth.uid in ['dqrHnJtM27bMpNudHxO5hL3wsNE3'];
    }

    // RULE 1: Public Collections
    // Allows anyone (even non-logged-in users) to read courses, instructors, etc.
    // This is critical for your public pages to work.
    // Only allows admins to write, update, or delete this content.
    match /(courses|instructors|blogPosts|events)/{docId} {
      allow get, list: if true;
      allow write: if request.auth != null && isAdmin();
    }

    // RULE 2: User Progress
    // A user can create their own progress document when they sign up.
    // A user can read or update their own data.
    // An admin can also read or update any user's progress.
    match /studentProgress/{userId} {
      allow get, update, delete: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow list: if request.auth != null && isAdmin(); // Only admins can list all users.
      allow create: if request.auth != null && request.auth.uid == userId;
    }

    // RULE 3: Feedback
    // Any logged-in user can submit feedback.
    // Only admins can read the feedback.
    // Feedback cannot be changed or deleted after submission.
    match /feedback/{feedbackId} {
      allow create: if request.auth != null;
      allow read, list: if request.auth != null && isAdmin();
      allow update, delete: if false;
    }

    // RULE 4: Event Attendees (subcollection)
    // A user can register for an event (create their own attendee document).
    // A user can view their own ticket, and admins can view all attendees.
    match /events/{eventId}/attendees/{userId} {
      allow get: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow list: if request.auth != null && isAdmin();
      allow write: if request.auth != null && (request.auth.uid == userId || isAdmin());
    }
  }
}
