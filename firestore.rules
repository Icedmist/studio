rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check for admin role
    function isAdmin() {
      // The ADMIN_UIDS are stored in your application code, this rule checks against that list.
      // Ensure the UIDs in /src/lib/admin.ts are correct.
      return request.auth != null && request.auth.uid in get(/databases/$(database)/documents/metadata/admins).data.uids;
    }
    
    // This is a placeholder for the above rule to work. In a real app you might have a document with admin UIDs.
    // For this project, we'll rely on the client-side check and secure writes.
    function isProjectAdmin() {
        return request.auth != null && request.auth.uid in ['dqrHnJtM27bMpNudHxO5hL3wsNE3']; // Replace with your actual admin UIDs
    }

    // Helper function to check if a user is the owner of a document
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Allow public read access to courses, instructors, blog posts, and events.
    // Writes are restricted to admins.
    match /{collectionName}/{docId}
      where collectionName in ['courses', 'instructors', 'events', 'blogPosts'] {
      allow get, list: if true;
      allow create, update, delete: if isProjectAdmin();
    }
    
    // Allow logged-in users to register for events.
    match /events/{eventId}/attendees/{userId} {
      allow get: if isOwner(userId) || isProjectAdmin();
      allow create: if isOwner(userId);
      allow update, delete: if isProjectAdmin();
    }
    
    // Users can only access their own progress.
    match /studentProgress/{userId} {
      allow get, update: if isOwner(userId);
      // Only admins can list all student progress or delete records.
      allow list, delete: if isProjectAdmin();
      // A user can create their own progress document.
      allow create: if request.auth != null && request.resource.id == request.auth.uid;
    }

    // Allow authenticated users to submit feedback.
    match /feedback/{feedbackId} {
      allow create: if request.auth != null;
      allow read, list, update, delete: if isProjectAdmin();
    }
  }
}